<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- Importing necessary libraries -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <style>
      /* Styles for loading indicator */
      #loading-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: none;
      }
      
      /* Styles for frame controls */
      #frame-controls {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 10px;
        display: flex;
        gap: 10px;
        z-index: 1000;
      }
      
      .frame-button {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      
      .frame-button:hover {
        opacity: 0.8;
      }
      
      /* Button color styles */
      #toggle-frame {
        background-color: #4caf50;
        color: white;
      }
      #black-frame {
        background-color: #000000;
        color: white;
      }
      #wood-frame {
        background-color: #8b4513;
        color: white;
      }
      #gold-frame {
        background-color: #ffd700;
        color: black;
      }
      #red-frame {
        background-color: #ff0000;
        color: white;
      }
      #play-mp3 {
        background-color: #007bff;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Loading indicator to show while the AR experience is loading -->
    <div id="loading-indicator">正在加載AR體驗，請稍候...</div>

    <!-- Frame control buttons for user interaction -->
    <div id="frame-controls">
      <button id="toggle-frame" class="frame-button">隱藏框架</button>
      <button id="black-frame" class="frame-button">Black</button>
      <button id="wood-frame" class="frame-button">Wood</button>
      <button id="gold-frame" class="frame-button">Gold</button>
      <button id="red-frame" class="frame-button">Red</button>
      <button id="play-mp3" class="frame-button">播放音效</button>
    </div>

    <!-- Video progress indicator -->
    <progress id="video-progress" value="0" max="100" style="width: 100%; display: none;"></progress>

    <!-- AR Scene setup -->
    <a-scene
      mindar-image="imageTargetSrc: https://cdn.glitch.global/5ccc0053-b02d-4729-80a7-aa2242565329/KKtargets.mind?v=1703167402947;warmupTolerance:5; missTolerance:600; filterMinCF:0.000001; filterBeta:500"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <!-- Assets used in the AR scene -->
      <a-assets>
        <img
          id="profile"
          src="https://cdn.glitch.global/d211842b-4e2a-433c-9456-93f3cc8260fe/%E5%A4%A7%E9%A0%AD%E7%85%A7.png?v=1699354398583"
        />
        <video
          id="video1"
          src="https://raw.githubusercontent.com/isaoinvest/1111-TEST/main/測試影片.mp4"
          crossorigin="anonymous"
          loop
        ></video>
        <a-asset-item
          id="raccoonModel"
          src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/image-tracking/assets/band-example/raccoon/scene.gltf"
        ></a-asset-item>
      </a-assets>

      <!-- Camera setup -->
      <a-camera
        position="0 0 0"
        look-controls="enabled: false"
        cursor="fuse: false; rayOrigin: mouse;"
        raycaster="far: 10; objects: .clickable"
      ></a-camera>

      <!-- AR Target and video container -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity id="video-container">
          <!-- Video to be displayed in AR -->
          <a-video
            src="#video1"
            height="1.05"
            width="1.5"
            position="0 0 0"
            rotation="0 0 0"
            class="clickable"
            click-handler1
          ></a-video>
          <!-- Frame around the video -->
          <a-entity id="video-frame" visible="true">
            <!-- Top -->
            <a-box
              position="0 0.5625 0"
              scale="1.5 0.05 0.05"
              color="#000000"
            ></a-box>
            <!-- Bottom -->
            <a-box
              position="0 -0.5625 0"
              scale="1.5 0.05 0.05"
              color="#000000"
            ></a-box>
            <!-- Left -->
            <a-box
              position="-0.75 0 0"
              scale="0.05 1.15 0.05"
              color="#000000"
            ></a-box>
            <!-- Right -->
            <a-box
              position="0.75 0 0"
              scale="0.05 1.15 0.05"
              color="#000000"
            ></a-box>
          </a-entity>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      // Component to handle video click events
      AFRAME.registerComponent("click-handler1", {
        init: function () {
          var video = document.querySelector("#video1");
          var playing = false;
          this.el.addEventListener("click", function () {
            console.log("Video clicked, playing state before click:", playing);
            if (!playing) {
              // Play the video if it's not already playing
              video.play().then(() => {
                console.log("Video is now playing.");
              }).catch((e) => console.error("Video play error:", e));
            } else {
              // Pause the video if it's currently playing
              video.pause();
              console.log("Video is now paused.");
            }
            playing = !playing; // Toggle playing state
          });
        },
      });

      // MP3 play button logic
      const mp3Button = document.getElementById("play-mp3");
      const mp3Sound = document.getElementById("mp3-sound");

      mp3Button.addEventListener("click", () => {
        console.log("MP3 button clicked.");
        // Play the MP3 sound
        mp3Sound.play().then(() => {
          console.log("MP3 sound is now playing.");
        }).catch((e) => console.error("MP3 play error:", e));
      });

      // Loading indicator logic
      const loadingIndicator = document.getElementById("loading-indicator");
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM fully loaded.");
        // Show loading indicator while AR scene is loading
        loadingIndicator.style.display = "block";
      });

      document.querySelector("a-scene").addEventListener("loaded", () => {
        console.log("A-Frame scene loaded.");
        // Hide loading indicator once AR scene is loaded
        loadingIndicator.style.display = "none";
      });

      // GSAP animation for 3D model
      const raccoonModel = document.querySelector("a-gltf-model");
      if (raccoonModel) {
        raccoonModel.addEventListener("loaded", () => {
          console.log("3D model loaded.");
          // Animate the 3D model's position using GSAP
          gsap.to(raccoonModel.object3D.position, {
            y: "+=0.1",
            duration: 2,
            yoyo: true,
            repeat: -1,
            ease: "power1.inOut",
          });
        });
      }

      // Hover effect for clickable elements
      const clickableElements = document.querySelectorAll(".clickable");
      clickableElements.forEach((element) => {
        element.addEventListener("mouseenter", () => {
          console.log("Mouse entered clickable element.");
          // Scale up the element when hovered over
          gsap.to(element.object3D.scale, {
            x: 1.4,
            y: 1.4,
            z: 1.4,
            duration: 0.3,
          });
        });
        element.addEventListener("mouseleave", () => {
          console.log("Mouse left clickable element.");
          // Scale back down when hover ends
          gsap.to(element.object3D.scale, { x: 1, y: 1, z: 1, duration: 0.3 });
        });
      });

      // Frame control logic
      const videoFrame = document.querySelector("#video-frame");
      const toggleFrameBtn = document.querySelector("#toggle-frame");
      const blackFrameBtn = document.querySelector("#black-frame");
      const woodFrameBtn = document.querySelector("#wood-frame");
      const goldFrameBtn = document.querySelector("#gold-frame");
      const redFrameBtn = document.querySelector("#red-frame");

      // Function to set frame color
      function setFrameColor(color) {
        console.log("Setting frame color to:", color);
        const frameParts = videoFrame.querySelectorAll("a-box");
        frameParts.forEach((part) => {
          part.setAttribute("color", color);
          part.removeAttribute("material");
        });
      }

      // Toggle frame visibility
      let frameVisible = true;
      toggleFrameBtn.addEventListener("click", () => {
        frameVisible = !frameVisible;
        videoFrame.setAttribute("visible", frameVisible);
        toggleFrameBtn.textContent = frameVisible ? "隱藏框架" : "顯示框架";
        console.log("Frame visibility toggled. Now visible:", frameVisible);
      });

      // Frame color change event listeners
      blackFrameBtn.addEventListener("click", () => setFrameColor("#000000"));
      redFrameBtn.addEventListener("click", () => setFrameColor("#FF0000"));

      // Video loading and error checking with progress indicator
      const video = document.getElementById("video1");
      const progress = document.getElementById("video-progress");

      video.addEventListener("progress", () => {
        console.log("Video progress event triggered.");
        progress.style.display = "block";
        if (video.buffered.length > 0) {
          const bufferedEnd = video.buffered.end(video.buffered.length - 1);
          const duration = video.duration;
          if (duration > 0) {
            progress.value = (bufferedEnd / duration) * 100;
            console.log("Buffered percentage:", progress.value);
          }
        }
      });

      video.addEventListener("loadeddata", () => {
        console.log("Video data loaded.");
        progress.style.display = "none";
      });

      // Observer to automatically play video when it comes into view
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            console.log("Video is in view, attempting to play.");
            video.play().catch((e) => console.error("Video play error:", e));
          }
        });
      });

      observer.observe(video);
    </script>
  </body>
</html>
